name: Docker Compose Deploy

on:
  push:
    branches: [ main ]  # Trigger the action on push to main branch

env:
  SERVICES: app,web,background  # Comma-separated list of services

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Read Docker Compose file
      id: docker_compose
      run: |
        echo "COMPOSE_SERVICES=$(yq e '.services | keys | join(",")' docker-compose.yml)" >> $GITHUB_OUTPUT

    - name: Build and push Docker images
      run: |
        IFS=',' read -ra SERVICES_ARRAY <<< "${{ env.SERVICES }}"
        for service in "${SERVICES_ARRAY[@]}"; do
          if [[ "${{ steps.docker_compose.outputs.COMPOSE_SERVICES }}" == *"$service"* ]]; then
            docker-compose build $service
            image_name=$(yq e ".services.$service.image" docker-compose.yml)
            docker tag $image_name ghcr.io/${{ github.repository }}/$image_name:${{ github.sha }}
            docker push ghcr.io/${{ github.repository }}/$image_name:${{ github.sha }}
          else
            echo "Service $service not found in docker-compose.yml"
          fi
        done